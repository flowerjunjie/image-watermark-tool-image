<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; worker-src 'self' blob:;">
  <title>å›¾ç‰‡æ°´å°å·¥å…· - æ¡Œé¢ç‰ˆ</title>
  <!-- å¼•å…¥CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/thumbnail-styles.css">
  <link rel="icon" href="public/images/icon.ico" type="image/x-icon">
  
  <!-- é”™è¯¯å¤„ç†å’Œè°ƒè¯• -->
  <script>
    // å…¨å±€é”™è¯¯å¤„ç†
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('å…¨å±€é”™è¯¯:', message, 'at', source, ':', lineno, ':', colno);
      const errorContainer = document.getElementById('error-container');
      if (errorContainer) {
        errorContainer.innerHTML += `<p>åŠ è½½é”™è¯¯: ${message}</p>`;
        errorContainer.classList.add('show');
      }
      return false;
    };
    
    // åº“åŠ è½½çŠ¶æ€
    window.libraryStatus = {
      jszip: false,
      gifwrap: false,
      omggif: false,
      imageq: false
    };
    
    // å…¨å±€å¤„ç†çŠ¶æ€æ ‡å¿—
    window.processingCancelled = false;
    
    // ç´§æ€¥å–æ¶ˆå¤„ç†å‡½æ•°
    window.emergencyCancel = function() {
      console.log('ç´§æ€¥å–æ¶ˆå¤„ç†');
      window.processingCancelled = true;
      
      // éšè—æ¨¡æ€æ¡†
      const processingModal = document.getElementById('processing-modal');
      if (processingModal) {
        processingModal.style.display = 'none';
      }
      
      // æ˜¾ç¤ºå–æ¶ˆæ¶ˆæ¯
      const statusMessage = document.getElementById('status-message');
      if (statusMessage) {
        statusMessage.textContent = 'å¤„ç†å·²å–æ¶ˆ';
        statusMessage.style.display = 'block';
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 3000);
      }
      
      // å°è¯•æ˜¾ç¤ºå·²åŠ è½½çš„å›¾ç‰‡
      if (window.watermarkState && window.watermarkState.files && window.watermarkState.files.length > 0) {
        if (typeof window.showImage === 'function') {
          window.showImage(0);
        }
        
        // æ›´æ–°ç¼©ç•¥å›¾
        if (typeof window.updateThumbnails === 'function') {
          window.updateThumbnails();
        }
      }
      
      return false; // é˜»æ­¢é»˜è®¤è¡Œä¸º
    };
    
    // æ£€æµ‹æ˜¯å¦åœ¨Electronç¯å¢ƒä¸­è¿è¡Œ
    window.isElectron = typeof window !== 'undefined' && 
                       typeof window.process === 'object' && 
                       typeof window.process.type === 'string' || 
                       typeof window.electronAPI !== 'undefined';
    
    // é˜²æ­¢Chromeæ‰©å±•è¿æ¥é”™è¯¯
    window.addEventListener('error', function(event) {
      if (event.message && (
          event.message.includes('Could not establish connection') || 
          event.message.includes('Receiving end does not exist')
      )) {
        // è¿™æ˜¯Chromeæ‰©å±•ç›¸å…³çš„é”™è¯¯ï¼Œå¯ä»¥å¿½ç•¥
        event.preventDefault();
        console.log('å¿½ç•¥Chromeæ‰©å±•è¿æ¥é”™è¯¯');
        return true;
      }
    });
    
    // åº“åŠ è½½å‡½æ•°
    function loadScript(localUrl, cdnUrl, id) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = localUrl;
        script.async = true;
        script.id = id;
        
        script.onload = function() {
          console.log(`æˆåŠŸåŠ è½½åº“: ${id}`);
          window.libraryStatus[id] = true;
          resolve();
        };
        
        script.onerror = function() {
          console.warn(`ä» ${localUrl} åŠ è½½åº“å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨URL: ${cdnUrl}`);
          if (cdnUrl) {
            const backupScript = document.createElement('script');
            backupScript.src = cdnUrl;
            backupScript.async = true;
            backupScript.id = id + '-backup';
            
            backupScript.onload = function() {
              console.log(`æˆåŠŸä»å¤‡ç”¨URLåŠ è½½åº“: ${id}`);
              window.libraryStatus[id] = true;
              resolve();
            };
            
            backupScript.onerror = function() {
              console.error(`ä»å¤‡ç”¨URLåŠ è½½åº“å¤±è´¥: ${id}`);
              reject(new Error(`æ— æ³•åŠ è½½åº“: ${id}`));
            };
            
            document.head.appendChild(backupScript);
          } else {
            reject(new Error(`æ— æ³•åŠ è½½åº“: ${id}`));
          }
        };
        
        document.head.appendChild(script);
      });
    }
  </script>
  
  <!-- åº“åŠ è½½ -->
  <script>
    // åŠ è½½æ‰€æœ‰å¿…è¦çš„åº“
    Promise.all([
      loadScript('public/libs/jszip.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js', 'jszip'),
      loadScript('public/libs/gifwrap.min.js', 'https://cdn.jsdelivr.net/npm/gifwrap@0.10.1/umd/gifwrap.min.js', 'gifwrap'),
      loadScript('public/libs/omggif.min.js', 'https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js', 'omggif'),
      loadScript('public/libs/image-q.min.js', 'https://cdn.jsdelivr.net/npm/image-q@4.0.0/dist/umd/image-q.min.js', 'imageq'),
      loadScript('public/libs/gif.js', 'public/libs/gif.min.js', 'gifjs'),
      loadScript('public/libs/gif.worker.js', 'public/libs/gif.worker.min.js', 'gifworker'),
      loadScript('public/libs/fabric.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js', 'fabricjs')
    ]).then(() => {
      console.log('æ‰€æœ‰åº“åŠ è½½æˆåŠŸ');
      
      // åŠ è½½æµ‹è¯•è„šæœ¬
      const testScript = document.createElement('script');
      testScript.src = 'js/utils/test-scripts/gifwrap-test.js';
      testScript.type = 'text/javascript';
      testScript.async = true;
      document.body.appendChild(testScript);
      
      // ä¸»åŠ¨åˆå§‹åŒ–GIFå¤„ç†å™¨
      try {
        // å¯¼å…¥GIFæ›´æ–°å¤„ç†å™¨
        import('./js/utils/gif/update-processor.js')
          .then(module => {
            if (module && typeof module.updateGifProcessor === 'function') {
              console.log('ä¸»åŠ¨åˆå§‹åŒ–GIFå¤„ç†å™¨');
              module.updateGifProcessor();
            }
          })
          .catch(err => {
            console.error('å¯¼å…¥GIFæ›´æ–°å¤„ç†å™¨å¤±è´¥:', err);
          });
          
        // å¦‚æœå­˜åœ¨å…¨å±€æ–¹æ³•ï¼Œä¹Ÿè°ƒç”¨å®ƒ
        if (typeof window.initGifProcessor === 'function') {
          console.log('è°ƒç”¨å…¨å±€GIFå¤„ç†å™¨åˆå§‹åŒ–');
          window.initGifProcessor();
        }
      } catch (error) {
        console.error('åˆå§‹åŒ–GIFå¤„ç†å™¨å¤±è´¥:', error);
      }
      
      // åŠ è½½æ¸²æŸ“å™¨è„šæœ¬ï¼ˆElectronç¯å¢ƒï¼‰
      if (window.isElectron) {
        console.log('Electronç¯å¢ƒæ£€æµ‹æˆåŠŸï¼ŒåŠ è½½æ¸²æŸ“å™¨è„šæœ¬');
        const rendererScript = document.createElement('script');
        rendererScript.src = 'renderer.js';
        rendererScript.type = 'text/javascript';
        document.body.appendChild(rendererScript);
      }
      
      // ç»§ç»­æ­£å¸¸çš„åˆå§‹åŒ–
      const appScript = document.createElement('script');
      appScript.src = 'js/main.js';
      document.body.appendChild(appScript);
      
    }).catch(error => {
      console.error('åº“åŠ è½½å¤±è´¥:', error);
      const errorContainer = document.getElementById('error-container');
      if (errorContainer) {
        errorContainer.innerHTML += `<p>åº“åŠ è½½å¤±è´¥: ${error.message}</p>`;
        errorContainer.classList.add('show');
      }
    });
    
    // åˆ›å»ºä¸€ä¸ªå…¨å±€å®¹å™¨ç”¨äºSuperGif
    window.onload = function() {
      try {
        const gifContainer = document.createElement('div');
        gifContainer.id = 'gif-container';
        gifContainer.style.position = 'absolute';
        gifContainer.style.left = '-9999px';
        gifContainer.style.top = '-9999px';
        document.body.appendChild(gifContainer);
        console.log('GIFå®¹å™¨åˆ›å»ºæˆåŠŸ');
        
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯èƒ½å¡ä½çš„æ¨¡æ€æ¡†
        setTimeout(() => {
          console.log('æ£€æŸ¥æ˜¯å¦æœ‰å¡ä½çš„æ¨¡æ€æ¡†...');
          const processingModal = document.getElementById('processing-modal');
          if (processingModal && processingModal.style.display === 'flex') {
            console.warn('æ£€æµ‹åˆ°å¯èƒ½å¡ä½çš„å¤„ç†ä¸­æ¨¡æ€æ¡†ï¼Œå¼ºåˆ¶å…³é—­');
            processingModal.style.display = 'none';
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const statusMessage = document.getElementById('status-message');
            if (statusMessage) {
              statusMessage.textContent = 'ç³»ç»Ÿå·²è‡ªåŠ¨æ¢å¤ï¼ˆå¤„ç†æ¨¡æ€æ¡†è¢«é‡ç½®ï¼‰';
              statusMessage.style.display = 'block';
              setTimeout(() => {
                statusMessage.style.display = 'none';
              }, 3000);
            }
          }
        }, 5000);
      } catch (error) {
        console.error('åˆ›å»ºGIFå®¹å™¨å¤±è´¥:', error);
      }
    };
  </script>
</head>
<body>
  <header>
    <h1>å›¾ç‰‡æ°´å°å·¥å…·</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="help-button" id="help-button" title="æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£">?</button>
      <span class="version">v1.0.0 (ç‹¬ç«‹ç‰ˆ)</span>
    </div>
  </header>
  
  <main>
    <div class="sidebar">
      <div id="error-container" class="error-container"></div>
      
      <div class="upload-area" id="upload-area">
        <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
        <p style="font-size: 12px; margin: 5px 0;">æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šå¼ å›¾ç‰‡æˆ–ä¸Šä¼ æ–‡ä»¶å¤¹</p>
        <p style="font-size: 12px; margin: 5px 0; color: #1976d2;">ç°åœ¨æ”¯æŒGIFåŠ¨å›¾å¤„ç†ï¼</p>
        <input type="file" id="file-input" accept="image/*" style="display: none;" multiple>
      </div>
      
      <div class="form-group">
        <div class="batch-buttons">
          <button class="button" id="upload-files-btn">ä¸Šä¼ å›¾ç‰‡</button>
          <button class="button" id="upload-folder-btn">ä¸Šä¼ æ–‡ä»¶å¤¹</button>
        </div>
      </div>
      
      <!-- å°†æ–‡ä»¶å¤¹è¾“å…¥æ¡†æ”¾åœ¨ä¸Šä¼ åŒºåŸŸå¤–éƒ¨ï¼Œé¿å…äº‹ä»¶å†’æ³¡é—®é¢˜ -->
      <input type="file" id="folder-input" style="display: none;" webkitdirectory directory multiple>
      
      <div class="help-card">
        <h3>ä½¿ç”¨å¸®åŠ©</h3>
        <ul>
          <li><span class="help-icon">ğŸ“¤</span> <strong>ä¸Šä¼ å›¾ç‰‡</strong>ï¼šå¯å•å¼ æˆ–æ‰¹é‡ä¸Šä¼ </li>
          <li><span class="help-icon">ğŸ“</span> <strong>ä¸Šä¼ æ–‡ä»¶å¤¹</strong>ï¼šä¿ç•™ç›®å½•ç»“æ„</li>
          <li><span class="help-icon">ğŸ–Œï¸</span> <strong>æ°´å°ç±»å‹</strong>ï¼šæ”¯æŒæ–‡å­—ã€å¹³é“ºå’Œå›¾ç‰‡æ°´å°</li>
          <li><span class="help-icon">âš™ï¸</span> <strong>æ‹–æ‹½å®šä½</strong>ï¼šå¯ç›´æ¥æ‹–åŠ¨æ°´å°è°ƒæ•´ä½ç½®</li>
          <li><span class="help-icon">ğŸ’¾</span> <strong>æ‰¹é‡å¤„ç†</strong>ï¼šä¸€æ¬¡å¤„ç†å¤šå¼ å›¾ç‰‡</li>
          <li><span class="help-icon">ğŸ“¦</span> <strong>æ‰¹é‡ä¸‹è½½</strong>ï¼šå°†å¤„ç†åçš„å›¾ç‰‡æ‰“åŒ…ä¸‹è½½</li>
          <li><span class="help-icon">ğŸï¸</span> <strong>GIFæ”¯æŒ</strong>ï¼šæ”¯æŒå¤„ç†GIFåŠ¨å›¾</li>
        </ul>
      </div>
      
      <!-- GIFå¤„ç†é€‰é¡¹ -->
      <div class="form-group" id="gif-options">
        <label for="gif-quality">GIFè´¨é‡ <span class="tooltip-icon" title="è°ƒæ•´GIFçš„è´¨é‡ï¼Œå€¼è¶Šä½æ–‡ä»¶è¶Šå°ï¼Œä½†è´¨é‡è¶Šå·®">?</span></label>
        <div class="range-container">
          <input type="range" id="gif-quality" min="1" max="20" value="10">
          <span id="gif-quality-value">10</span>
        </div>
        <div class="gif-progress-container" id="gif-progress-container" style="display: none;">
          <div class="gif-progress-bar" id="gif-progress-bar"></div>
        </div>
      </div>
      
      <div class="watermark-options">
        <div class="form-group">
          <label for="watermark-type">æ°´å°ç±»å‹ <span class="tooltip-icon" title="é€‰æ‹©ä¸åŒç±»å‹çš„æ°´å°ï¼šæ–‡å­—ã€å¹³é“ºæˆ–å›¾ç‰‡">?</span></label>
          <select id="watermark-type">
            <option value="text">æ–‡å­—æ°´å°</option>
            <option value="tiled">å¹³é“ºæ°´å°</option>
            <option value="image">å›¾ç‰‡æ°´å°</option>
          </select>
        </div>
        
        <div class="form-group" id="tiled-options" style="display: none;">
          <label for="tile-spacing">å¹³é“ºé—´è·</label>
          <div class="range-container">
            <input type="range" id="tile-spacing" min="50" max="300" value="150">
            <span id="tile-spacing-value">150px</span>
          </div>
        </div>
        
        <div class="form-group" id="text-options">
          <label for="watermark-text">æ°´å°æ–‡å­—</label>
          <input type="text" id="watermark-text" value="ä»…ä¾›éªŒè¯ä½¿ç”¨">
        </div>
        
        <div class="form-group" id="image-options" style="display: none;">
          <label for="watermark-image">é€‰æ‹©æ°´å°å›¾ç‰‡</label>
          <div class="upload-area" id="watermark-image-area">
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡ä½œä¸ºæ°´å°</p>
            <input type="file" id="watermark-image-input" accept="image/*" style="display: none;">
          </div>
          <div id="watermark-image-preview" style="display: none; margin-top: 10px; text-align: center;">
            <img id="watermark-image-thumbnail" style="max-width: 100%; max-height: 100px; border: 1px solid #ddd;">
            <button class="button" id="remove-watermark-image" style="margin-top: 5px; background-color: #f44336;">ç§»é™¤æ°´å°å›¾ç‰‡</button>
          </div>
          <div class="form-group">
            <label for="watermark-image-size">æ°´å°å›¾ç‰‡å¤§å°</label>
            <div class="range-container">
              <input type="range" id="watermark-image-size" min="10" max="100" value="40">
              <span id="watermark-image-size-value">40%</span>
            </div>
          </div>
        </div>
        
        <!-- é€šç”¨é€‰é¡¹ -->
        <div class="form-group">
          <label for="font-size">å­—ä½“å¤§å° <span class="tooltip-icon" title="è°ƒæ•´æ°´å°æ–‡å­—çš„å¤§å°">?</span></label>
          <div class="range-container">
            <input type="range" id="font-size" min="10" max="100" value="36">
            <span id="font-size-value">36</span>
            <div class="number-input-container">
              <button class="number-btn" id="font-size-decrease">-</button>
              <input type="number" id="font-size-input" min="10" max="100" value="36" class="number-input" title="å­—ä½“å¤§å°è¾“å…¥">
              <button class="number-btn" id="font-size-increase">+</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="opacity">é€æ˜åº¦ <span class="tooltip-icon" title="è°ƒæ•´æ°´å°çš„é€æ˜åº¦ï¼Œå€¼è¶Šå°è¶Šé€æ˜">?</span></label>
          <div class="range-container">
            <input type="range" id="opacity" min="0" max="100" value="50">
            <span id="opacity-value">50%</span>
            <div class="number-input-container">
              <button class="number-btn" id="opacity-decrease">-</button>
              <input type="number" id="opacity-input" min="0" max="100" value="50" class="number-input" title="é€æ˜åº¦è¾“å…¥">
              <button class="number-btn" id="opacity-increase">+</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="rotation">æ—‹è½¬è§’åº¦ <span class="tooltip-icon" title="è°ƒæ•´æ°´å°çš„å€¾æ–œè§’åº¦">?</span></label>
          <div class="range-container">
            <input type="range" id="rotation" min="-180" max="180" value="0">
            <span id="rotation-value">0Â°</span>
            <div class="number-input-container">
              <button class="number-btn" id="rotation-decrease">-</button>
              <input type="number" id="rotation-input" min="-180" max="180" value="0" class="number-input" title="æ—‹è½¬è§’åº¦è¾“å…¥">
              <button class="number-btn" id="rotation-increase">+</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="color">é¢œè‰² <span class="tooltip-icon" title="é€‰æ‹©æ°´å°çš„é¢œè‰²">?</span></label>
          <input type="color" id="color" value="#ff0000">
        </div>
        
        <!-- å›¾ç‰‡è¾“å‡ºé€‰é¡¹ -->
        <div class="form-group">
          <label for="image-quality">å›¾ç‰‡è´¨é‡ <span class="tooltip-icon" title="è°ƒæ•´è¾“å‡ºå›¾ç‰‡çš„è´¨é‡ï¼Œå€¼è¶Šé«˜è´¨é‡è¶Šå¥½ï¼Œæ–‡ä»¶è¶Šå¤§">?</span></label>
          <div class="range-container">
            <input type="range" id="image-quality" min="10" max="100" value="92">
            <span id="image-quality-value">92%</span>
          </div>
        </div>
        
        <!-- æš‚æ—¶æ³¨é‡Šæ‰è¾“å‡ºæ ¼å¼é€‰æ‹©
        <div class="form-group">
          <label for="image-format">è¾“å‡ºæ ¼å¼ <span class="tooltip-icon" title="é€‰æ‹©è¾“å‡ºå›¾ç‰‡çš„æ ¼å¼">?</span></label>
          <select id="image-format">
            <option value="image/jpeg">JPEG (æ¨è)</option>
            <option value="image/png">PNG (æ— æŸ)</option>
            <option value="image/webp">WebP (é«˜å‹ç¼©ç‡)</option>
          </select>
        </div>
        -->
        
        <p class="help-text">æç¤ºï¼šå¯ä»¥ç›´æ¥æ‹–åŠ¨æ°´å°è°ƒæ•´ä½ç½®ï¼Œé¼ æ ‡æ»šè½®è°ƒæ•´å¤§å°</p>
        
        <!-- æ°´å°å®šä½å’Œç¼©æ”¾æ§åˆ¶ -->
        <div class="control-group">
          <h3>æ°´å°ç¼©æ”¾</h3>
          <div class="scale-controls">
            <div class="radio-group">
              <label><input type="radio" name="scale-mode" value="fixed" checked> <span>å›ºå®šå¤§å°</span></label>
              <label><input type="radio" name="scale-mode" value="relative"> <span>ç›¸å¯¹å›¾ç‰‡å¤§å°</span></label>
            </div>
            
            <div id="relative-scale-controls" style="display: none;">
              <div class="slider-control">
                <label>ç¼©æ”¾æ¯”ä¾‹ <span class="tooltip-icon" title="æ°´å°ç›¸å¯¹äºå›¾ç‰‡å¤§å°çš„æ¯”ä¾‹">?</span></label>
                <input type="range" id="scale-ratio-slider" min="5" max="50" value="20">
                <div class="slider-value">
                  <input type="number" id="scale-ratio-value" min="5" max="50" value="20">
                  <span>%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="batch-buttons">
          <button class="button" id="download-btn">ä¸‹è½½å•å¼ å›¾ç‰‡</button>
          <button class="button" id="batch-download-btn">æ‰¹é‡ä¸‹è½½(ZIP)</button>
        </div>
        
        <!-- æ’¤é”€/é‡åšæŒ‰é’® -->
        <div class="undo-redo-buttons">
          <button class="icon-button" id="undo-btn" title="æ’¤é”€"><span class="icon">â†©</span></button>
          <button class="icon-button" id="redo-btn" title="é‡åš"><span class="icon">â†ª</span></button>
        </div>
      </div>
    </div>
    
    <div class="preview-area">
      <!-- æ·»åŠ èƒŒæ™¯è‰²åˆ‡æ¢æ§ä»¶ -->
      <div class="bg-color-controls">
        <div class="bg-color-button bg-white active" data-color="#ffffff" title="ç™½è‰²èƒŒæ™¯"></div>
        <div class="bg-color-button bg-light-gray" data-color="#f5f5f5" title="æµ…ç°èƒŒæ™¯"></div>
        <div class="bg-color-button bg-light-blue" data-color="#e6f7ff" title="æµ…è“èƒŒæ™¯"></div>
        <div class="bg-color-button bg-light-green" data-color="#e6ffed" title="æµ…ç»¿èƒŒæ™¯"></div>
        <div class="bg-color-button bg-light-yellow" data-color="#fffbe6" title="æµ…é»„èƒŒæ™¯"></div>
      </div>
      
      <!-- åº”ç”¨åˆ°æ‰€æœ‰æŒ‰é’® -->
      <button class="button" id="apply-to-all-btn" style="background-color: #ff4949; color: white; font-weight: bold; margin-top: 10px; width: 100%; max-width: 150px;">åº”ç”¨åˆ°æ‰€æœ‰</button>
      
      <div class="preview-container" id="preview-container">
        <div id="no-image-message" style="text-align: center; padding: 40px; font-size: 18px; color: #666; background-color: #f9f9f9; border-radius: 8px; border: 2px dashed #ddd; width: 80%; max-width: 400px; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">è¯·ä¸Šä¼ å›¾ç‰‡è¿›è¡Œé¢„è§ˆ</div>
        <div id="gif-badge" class="gif-badge" style="display: none;">GIF</div>
        <img id="preview-image" class="preview-image" style="display: none;">
        <canvas id="preview-canvas" class="preview-image" style="display: none;"></canvas>
        <div id="watermark-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto; z-index: 9999; display: flex; overflow: visible;"></div>
      </div>
      
      <div class="thumbnails-container" id="thumbnails-container" style="display: none;"></div>
    </div>
  </main>
  
  <!-- è¿›åº¦æ¨¡æ€æ¡† -->
  <div id="processing-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">å¤„ç†ä¸­...</h2>
      <p id="processing-status">æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
      <div class="progress-container" style="display: block;">
        <div id="modal-progress-bar" class="progress-bar" style="width: 0%">0%</div>
      </div>
      <!-- æ·»åŠ å–æ¶ˆæŒ‰é’®å’Œå€’è®¡æ—¶ -->
      <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div id="modal-countdown" style="font-size: 12px; color: #666;">è‡ªåŠ¨å…³é—­: 10</div>
        <button id="cancel-processing-btn" onclick="return window.emergencyCancel();" style="padding: 5px 15px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  
  <!-- å¸®åŠ©æ–‡æ¡£æ¨¡æ€æ¡† -->
  <div id="help-modal" class="modal">
    <div class="help-modal-content" id="help-modal-content">
      <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>
    <button class="close-button">&times;</button>
  </div>
  
  <!-- çŠ¶æ€æ¶ˆæ¯ -->
  <div id="status-message" class="status-message"></div>
  
  <!-- å¤„ç†ä¸­å¼¹çª— -->
  <div id="processing-popup" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>å¤„ç†ä¸­...</h3>
      <div id="processing-status" class="processing-status">æ­£åœ¨å‡†å¤‡å›¾ç‰‡...</div>
      <div class="progress-container">
        <div id="processing-progress-bar" class="progress-bar"></div>
      </div>
      <div id="processing-details" class="processing-details"></div>
      
      <!-- æ·»åŠ å¤„ç†ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ -->
      <div class="processing-stats">
        <div class="stats-row">
          <div class="stats-item" id="processing-time">
            <div class="stats-label">å·²ç”¨æ—¶é—´</div>
            <div class="stats-value">0ç§’</div>
          </div>
          <div class="stats-item" id="processing-remaining">
            <div class="stats-label">é¢„è®¡å‰©ä½™</div>
            <div class="stats-value">è®¡ç®—ä¸­...</div>
          </div>
        </div>
        <div class="stats-row">
          <div class="stats-item" id="processing-speed">
            <div class="stats-label">å¤„ç†é€Ÿåº¦</div>
            <div class="stats-value">0å¼ /ç§’</div>
          </div>
          <div class="stats-item" id="processing-count">
            <div class="stats-label">å¤„ç†è¿›åº¦</div>
            <div class="stats-value">0/0</div>
          </div>
        </div>
      </div>
      
      <!-- æ·»åŠ å–æ¶ˆæŒ‰é’® -->
      <div class="processing-actions">
        <button id="processing-minimize-btn" class="button secondary">æœ€å°åŒ–</button>
        <!-- å–æ¶ˆåŠŸèƒ½æš‚æœªå®ç°ï¼Œå…ˆæ³¨é‡Šæ‰ -->
        <!-- <button id="processing-cancel-btn" class="button danger">å–æ¶ˆ</button> -->
      </div>
    </div>
  </div>
  
  <!-- å¼•å…¥JavaScriptæ¨¡å— -->
  <script src="js/main.js"></script>
  
  <!-- GIFæ°´å°å¤„ç†è„šæœ¬ -->
  <script src="js/utils/gif-watermarker.js"></script>
  <script src="js/utils/gif-watermark-ui.js"></script>
  
  <!-- åˆå§‹åŒ–GIFæ°´å°åŠŸèƒ½ -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // è®¾ç½®å…¨å±€æ ‡å¿—ï¼Œè·Ÿè¸ªGIFæ°´å°UIåˆå§‹åŒ–çŠ¶æ€
      window.gifWatermarkUIInitialized = false;
      
      // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿å…¶ä»–è„šæœ¬å·²åŠ è½½
      setTimeout(function() {
        if (!window.gifWatermarkUIInitialized && window.GifWatermarkUI && typeof window.GifWatermarkUI.init === 'function') {
          console.log('åˆå§‹åŒ–GIFæ°´å°UI');
          window.GifWatermarkUI.init();
          window.gifWatermarkUIInitialized = true;
        } else if (window.gifWatermarkUIInitialized) {
          console.log('GIFæ°´å°UIå·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
        } else {
          console.warn('GIFæ°´å°UIæœªåŠ è½½');
        }
      }, 1000);
    });
  </script>
  
  <!-- æ¨¡æ€å¯¹è¯æ¡†è‡ªåŠ¨å…³é—­å€’è®¡æ—¶è„šæœ¬ -->
  <script>
    // æ¨¡æ€å¯¹è¯æ¡†è‡ªåŠ¨å…³é—­å€’è®¡æ—¶
    document.addEventListener('DOMContentLoaded', function() {
      const processingModal = document.getElementById('processing-modal');
      const modalCountdown = document.getElementById('modal-countdown');
      
      if (processingModal && modalCountdown) {
        // ç›‘å¬æ¨¡æ€å¯¹è¯æ¡†æ˜¾ç¤º
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'style' && 
                processingModal.style.display === 'flex') {
              // æ¨¡æ€å¯¹è¯æ¡†æ˜¾ç¤ºæ—¶ï¼Œå¯åŠ¨å€’è®¡æ—¶
              startModalCountdown();
            }
          });
        });
        
        // é…ç½®è§‚å¯Ÿå™¨
        observer.observe(processingModal, { attributes: true });
        
        // å€’è®¡æ—¶å‡½æ•°
        function startModalCountdown() {
          let countdownValue = 30; // é»˜è®¤30ç§’
          
          // å¦‚æœå·²ç»æœ‰å€’è®¡æ—¶å€¼ï¼Œåˆ™ä½¿ç”¨å®ƒ
          const countdownText = modalCountdown.textContent;
          const match = countdownText.match(/\d+/);
          if (match) {
            countdownValue = parseInt(match[0], 10);
          }
          
          modalCountdown.textContent = `è‡ªåŠ¨å…³é—­: ${countdownValue}`;
          
          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
          if (window.modalCountdownTimer) {
            clearInterval(window.modalCountdownTimer);
          }
          
          // å¯åŠ¨æ–°çš„å®šæ—¶å™¨
          window.modalCountdownTimer = setInterval(function() {
            countdownValue--;
            
            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            if (modalCountdown) {
              modalCountdown.textContent = `è‡ªåŠ¨å…³é—­: ${countdownValue}`;
            }
            
            // å€’è®¡æ—¶ç»“æŸæ—¶å…³é—­æ¨¡æ€æ¡†
            if (countdownValue <= 0) {
              clearInterval(window.modalCountdownTimer);
              
              if (processingModal.style.display === 'flex') {
                console.log('å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨å…³é—­æ¨¡æ€æ¡†');
                processingModal.style.display = 'none';
                
                // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
                const statusMessage = document.getElementById('status-message');
                if (statusMessage) {
                  statusMessage.textContent = 'å¤„ç†å·²å®Œæˆï¼ˆè‡ªåŠ¨å…³é—­ï¼‰';
                  statusMessage.style.display = 'block';
                  setTimeout(() => {
                    statusMessage.style.display = 'none';
                  }, 3000);
                }
              }
            }
          }, 1000);
        }
      }
    });
  </script>
  
  <!-- æ¨¡å—åŠ è½½å¤±è´¥æ—¶çš„å¤‡é€‰æ–¹æ¡ˆ -->
  <script>
    // æ£€æµ‹æ¨¡å—åŠ è½½æ˜¯å¦å¤±è´¥
    setTimeout(() => {
      if (!window.watermarkInitialized) {
        console.log('æ¨¡å—åŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä¼ ç»Ÿè„šæœ¬åŠ è½½');
        const errorMsg = document.getElementById('error-container');
        if (errorMsg) {
          errorMsg.innerHTML = '<div class="error-title">æ¨¡å—åŠ è½½å¤±è´¥</div>' +
            '<p>å¯èƒ½çš„åŸå› ï¼š</p>' +
            '<ul>' +
            '<li>æµè§ˆå™¨ä¸æ”¯æŒESæ¨¡å—</li>' +
            '<li>å¤–éƒ¨åº“åŠ è½½å¤±è´¥</li>' +
            '<li>JavaScripté”™è¯¯é˜»æ­¢äº†åˆå§‹åŒ–</li>' +
            '</ul>' +
            '<p>è¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ³•ï¼š</p>' +
            '<ol>' +
            '<li>ä½¿ç”¨å‘½ä»¤è¡Œè¿›å…¥é¡¹ç›®ç›®å½•</li>' +
            '<li>è¿è¡Œ <code>npx http-server .</code> å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨</li>' +
            '<li>åœ¨æµè§ˆå™¨ä¸­è®¿é—® <a href="http://localhost:8080/standalone-app-new.html">http://localhost:8080/standalone-app-new.html</a></li>' +
            '<li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°(F12)æŸ¥çœ‹å…·ä½“é”™è¯¯</li>' +
            '</ol>';
          errorMsg.classList.add('show');
          
          // æ˜¾ç¤ºåº“åŠ è½½çŠ¶æ€
          const libraryStatus = window.libraryStatus || {};
          const statusHTML = '<div class="library-status">' +
            '<p>åº“åŠ è½½çŠ¶æ€ï¼š</p>' +
            '<ul>' +
            `<li>JSZip: ${libraryStatus.jszip ? 'âœ…' : 'âŒ'}</li>` +
            `<li>gifwrap: ${libraryStatus.gifwrap ? 'âœ…' : 'âŒ'}</li>` +
            `<li>omggif: ${libraryStatus.omggif ? 'âœ…' : 'âŒ'}</li>` +
            `<li>image-q: ${libraryStatus.imageq ? 'âœ…' : 'âŒ'}</li>` +
            '</ul>' +
            '</div>';
          errorMsg.innerHTML += statusHTML;
          
          // æ£€æŸ¥æ˜¯å¦æœ‰å…·ä½“çš„æ¨¡å—å¯¼å…¥é”™è¯¯
          const importErrors = document.querySelectorAll('body > script[type="module"]');
          if (importErrors.length > 0) {
            errorMsg.innerHTML += '<div class="error-details">' +
              '<p>æ£€æµ‹åˆ°å¯èƒ½çš„æ¨¡å—å¯¼å…¥é”™è¯¯ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚</p>' +
              '<p>å¸¸è§åŸå› ï¼šæ¨¡å—è·¯å¾„é”™è¯¯ã€ESæ¨¡å—è¯­æ³•é”™è¯¯ã€è·¨åŸŸé—®é¢˜</p>' +
              '</div>';
          }
        }
      }
    }, 3000); // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°3ç§’
  </script>
  
  <!-- è°ƒè¯•ä¿®å¤GIFç™½å±é—®é¢˜ -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('åˆå§‹åŒ–GIFç™½å±é—®é¢˜ä¿®å¤è„šæœ¬ - gifwrapç‰ˆæœ¬');
      
      // ç›‘å¬æ˜¾ç¤ºGIFæ—¶çš„é”™è¯¯
      document.addEventListener('previewUpdate', function(event) {
        if (event.detail && event.detail.processResult && event.detail.processResult.isGif) {
          console.log('ç›‘æµ‹åˆ°GIFé¢„è§ˆæ›´æ–°äº‹ä»¶', event.detail);
          
          // è·å–é¢„è§ˆå›¾åƒ
          const previewImage = document.getElementById('preview-image');
          const gifBadge = document.getElementById('gif-badge');
          
          // æ˜¾ç¤ºGIFæ ‡è®°
          if (gifBadge) {
            gifBadge.style.display = 'block';
          }
          
          if (previewImage) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤„ç†åçš„ç¬¬ä¸€å¸§é¢„è§ˆï¼ˆå¸¦æ°´å°ï¼‰
            const processResult = event.detail.processResult;
            if (processResult.previewUrl) {
              console.log('ä½¿ç”¨å¤„ç†åçš„ç¬¬ä¸€å¸§é¢„è§ˆï¼ˆå¸¦æ°´å°ï¼‰');
              previewImage.src = processResult.previewUrl;
              previewImage.style.display = 'block';
              
              // æ˜¾ç¤ºæ°´å°çŠ¶æ€
              const noImageMessage = document.getElementById('no-image-message');
              if (noImageMessage) {
                if (processResult.watermarkApplied) {
                  noImageMessage.style.display = 'none';
                } else {
                  // å¦‚æœåªæœ‰é¢„è§ˆå¸¦æ°´å°ï¼Œä½†GIFæœ¬èº«æ²¡æœ‰æ°´å°ï¼Œæ˜¾ç¤ºæç¤º
                  noImageMessage.textContent = 'GIFé¢„è§ˆå¸¦æ°´å°ï¼Œä½†ä¸‹è½½çš„GIFå¯èƒ½ä¸åŒ…å«æ°´å°';
                  noImageMessage.style.display = 'block';
                  noImageMessage.style.backgroundColor = 'rgba(255, 165, 0, 0.8)'; // æ©™è‰²èƒŒæ™¯
                  
                  // 3ç§’åéšè—æç¤º
                  setTimeout(() => {
                    noImageMessage.style.display = 'none';
                  }, 5000);
                }
              }
              
              return; // ä½¿ç”¨é¢„è§ˆå¸§ï¼Œä¸éœ€è¦ç»§ç»­å¤„ç†
            }
            
            // æ·»åŠ é¢å¤–çš„é”™è¯¯å¤„ç†
            previewImage.onerror = function(error) {
              console.error('GIFé¢„è§ˆåŠ è½½é”™è¯¯:', error);
              
              // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
              const noImageMessage = document.getElementById('no-image-message');
              if (noImageMessage) {
                noImageMessage.textContent = 'GIFåŠ è½½å‡ºé”™ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–‡ä»¶...';
                noImageMessage.style.display = 'block';
              }
              
              // å°è¯•ä½¿ç”¨åŸå§‹æ–‡ä»¶
              if (event.detail.file) {
                setTimeout(function() {
                  const fileUrl = URL.createObjectURL(event.detail.file);
                  previewImage.src = fileUrl;
                  
                  // æµ‹è¯•å›¾åƒæ˜¯å¦èƒ½æ­£ç¡®åŠ è½½
                  previewImage.onload = function() {
                    console.log('æˆåŠŸä½¿ç”¨åŸå§‹GIFä½œä¸ºå¤‡ç”¨');
                    
                    // éšè—é”™è¯¯æ¶ˆæ¯
                    if (noImageMessage) noImageMessage.style.display = 'none';
                    
                    // æ˜¾ç¤ºå›¾åƒ
                    previewImage.style.display = 'block';
                  };
                }, 500);
              }
            };
            
            // ç›‘å¬åŠ è½½äº‹ä»¶ä»¥æ£€æµ‹ç™½å±
            previewImage.onload = function() {
              // å¦‚æœå›¾åƒæ²¡æœ‰å°ºå¯¸ï¼Œå¯èƒ½æ˜¯ç™½å±
              if (previewImage.naturalWidth === 0 || previewImage.naturalHeight === 0) {
                console.warn('æ£€æµ‹åˆ°å¯èƒ½çš„GIFç™½å±é—®é¢˜ - å°ºå¯¸ä¸ºé›¶');
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const noImageMessage = document.getElementById('no-image-message');
                if (noImageMessage) {
                  noImageMessage.textContent = 'GIFå¯èƒ½åŠ è½½æœ‰è¯¯ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–‡ä»¶...';
                  noImageMessage.style.display = 'block';
                }
                
                // å°è¯•ä½¿ç”¨åŸå§‹æ–‡ä»¶
                if (event.detail.file) {
                  setTimeout(function() {
                    const fileUrl = URL.createObjectURL(event.detail.file);
                    previewImage.src = fileUrl;
                    
                    console.log('å°è¯•ä½¿ç”¨åŸå§‹GIFä½œä¸ºå¤‡ç”¨');
                  }, 500);
                }
              } else {
                console.log('GIFé¢„è§ˆåŠ è½½æˆåŠŸï¼Œå°ºå¯¸:', previewImage.naturalWidth, 'x', previewImage.naturalHeight);
              }
            };
          }
        }
      });
      
      // æ·»åŠ è¯Šæ–­åŠŸèƒ½ - æ£€æµ‹gifwrapåº“æ˜¯å¦æ­£ç¡®åŠ è½½
      setTimeout(() => {
        console.log('æ£€æŸ¥gifwrapåº“åŠ è½½çŠ¶æ€...');
        if (window.gifwrap) {
          console.log('gifwrapåº“å·²æˆåŠŸåŠ è½½');
        } else {
          console.error('gifwrapåº“æœªåŠ è½½æˆåŠŸ');
          const errorContainer = document.getElementById('error-container');
          if (errorContainer) {
            errorContainer.innerHTML += '<p>è­¦å‘Š: gifwrapåº“æœªåŠ è½½æˆåŠŸï¼ŒGIFå¤„ç†å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ</p>';
            errorContainer.classList.add('show');
          }
        }
        
        if (window.omggif) {
          console.log('omggifåº“å·²æˆåŠŸåŠ è½½');
        } else {
          console.error('omggifåº“æœªåŠ è½½æˆåŠŸ');
        }
        
        if (window.imageQ) {
          console.log('image-qåº“å·²æˆåŠŸåŠ è½½');
        } else {
          console.error('image-qåº“æœªåŠ è½½æˆåŠŸ');
        }
      }, 2000);
    });
  </script>
</body>
</html>  