<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图片水印工具 - 独立版</title>
  <!-- 引入CSS -->
  <link rel="stylesheet" href="css/main.css">
  <!-- 引入JSZip库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- 引入GIF.js库 -->
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
  <!-- 引入libgif-js库 -->
  <script>
    // 创建一个全局容器用于SuperGif
    window.onload = function() {
      const gifContainer = document.createElement('div');
      gifContainer.id = 'gif-container';
      gifContainer.style.position = 'absolute';
      gifContainer.style.left = '-9999px';
      gifContainer.style.top = '-9999px';
      document.body.appendChild(gifContainer);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/gh/buzzfeed/libgif-js@master/libgif.js"></script>
</head>
<body>
  <header>
    <h1>图片水印工具</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="help-button" id="help-button" title="查看帮助文档">?</button>
      <span class="version">v1.0.0 (独立版)</span>
    </div>
  </header>
  
  <main>
    <div class="sidebar">
      <div id="error-container" class="error-container"></div>
      
      <div class="upload-area" id="upload-area">
        <p>点击或拖拽图片到这里</p>
        <p style="font-size: 12px; margin: 5px 0;">支持批量上传多张图片或上传文件夹</p>
        <p style="font-size: 12px; margin: 5px 0; color: #1976d2;">现在支持GIF动图处理！</p>
        <input type="file" id="file-input" accept="image/*" style="display: none;" multiple>
      </div>
      
      <div class="form-group">
        <div class="batch-buttons">
          <button class="button" id="upload-files-btn">上传图片</button>
          <button class="button" id="upload-folder-btn">上传文件夹</button>
        </div>
      </div>
      
      <!-- 将文件夹输入框放在上传区域外部，避免事件冒泡问题 -->
      <input type="file" id="folder-input" style="display: none;" webkitdirectory directory multiple>
      
      <div class="help-card">
        <h3>使用帮助</h3>
        <ul>
          <li><span class="help-icon">📤</span> <strong>上传图片</strong>：可单张或批量上传</li>
          <li><span class="help-icon">📁</span> <strong>上传文件夹</strong>：保留目录结构</li>
          <li><span class="help-icon">🖌️</span> <strong>水印类型</strong>：支持文字、平铺和图片水印</li>
          <li><span class="help-icon">⚙️</span> <strong>拖拽定位</strong>：可直接拖动水印调整位置</li>
          <li><span class="help-icon">💾</span> <strong>批量处理</strong>：一次处理多张图片</li>
          <li><span class="help-icon">📦</span> <strong>批量下载</strong>：将处理后的图片打包下载</li>
          <li><span class="help-icon">🎞️</span> <strong>GIF支持</strong>：支持处理GIF动图</li>
        </ul>
      </div>
      
      <!-- GIF处理选项 -->
      <div class="form-group" id="gif-options">
        <label for="gif-quality">GIF质量 <span class="tooltip-icon" title="调整GIF的质量，值越低文件越小，但质量越差">?</span></label>
        <div class="range-container">
          <input type="range" id="gif-quality" min="1" max="20" value="10">
          <span id="gif-quality-value">10</span>
        </div>
        <div class="gif-progress-container" id="gif-progress-container" style="display: none;">
          <div class="gif-progress-bar" id="gif-progress-bar"></div>
        </div>
      </div>
      
      <div class="watermark-options">
        <div class="form-group">
          <label for="watermark-type">水印类型 <span class="tooltip-icon" title="选择不同类型的水印：文字、平铺或图片">?</span></label>
          <select id="watermark-type">
            <option value="text">文字水印</option>
            <option value="tiled">平铺水印</option>
            <option value="image">图片水印</option>
          </select>
        </div>
        
        <div class="form-group" id="tiled-options" style="display: none;">
          <label for="tile-spacing">平铺间距</label>
          <div class="range-container">
            <input type="range" id="tile-spacing" min="50" max="300" value="150">
            <span id="tile-spacing-value">150px</span>
          </div>
        </div>
        
        <div class="form-group" id="text-options">
          <label for="watermark-text">水印文字</label>
          <input type="text" id="watermark-text" value="仅供验证使用">
        </div>
        
        <div class="form-group" id="image-options" style="display: none;">
          <label for="watermark-image">选择水印图片</label>
          <div class="upload-area" id="watermark-image-area">
            <p>点击或拖拽图片作为水印</p>
            <input type="file" id="watermark-image-input" accept="image/*" style="display: none;">
          </div>
          <div id="watermark-image-preview" style="display: none; margin-top: 10px; text-align: center;">
            <img id="watermark-image-thumbnail" style="max-width: 100%; max-height: 100px; border: 1px solid #ddd;">
            <button class="button" id="remove-watermark-image" style="margin-top: 5px; background-color: #f44336;">移除水印图片</button>
          </div>
          <div class="form-group">
            <label for="watermark-image-size">水印图片大小</label>
            <div class="range-container">
              <input type="range" id="watermark-image-size" min="10" max="100" value="40">
              <span id="watermark-image-size-value">40%</span>
            </div>
          </div>
        </div>
        
        <!-- 通用选项 -->
        <div class="form-group">
          <label for="font-size">字体大小 <span class="tooltip-icon" title="调整水印文字的大小">?</span></label>
          <div class="range-container">
            <input type="range" id="font-size" min="10" max="100" value="36">
            <span id="font-size-value">36</span>
            <div class="number-input-container">
              <button class="number-btn" id="font-size-decrease">-</button>
              <input type="number" id="font-size-input" min="10" max="100" value="36" class="number-input">
              <button class="number-btn" id="font-size-increase">+</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="opacity">透明度 <span class="tooltip-icon" title="调整水印的透明度，值越小越透明">?</span></label>
          <div class="range-container">
            <input type="range" id="opacity" min="0" max="100" value="50">
            <span id="opacity-value">50%</span>
            <div class="number-input-container">
              <button class="number-btn" id="opacity-decrease">-</button>
              <input type="number" id="opacity-input" min="0" max="100" value="50" class="number-input">
              <button class="number-btn" id="opacity-increase">+</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="rotation">旋转角度 <span class="tooltip-icon" title="调整水印的倾斜角度">?</span></label>
          <div class="range-container">
            <input type="range" id="rotation" min="-180" max="180" value="0">
            <span id="rotation-value">0°</span>
            <div class="number-input-container">
              <button class="number-btn" id="rotation-decrease">-</button>
              <input type="number" id="rotation-input" min="-180" max="180" value="0" class="number-input">
              <button class="number-btn" id="rotation-increase">+</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="color">颜色 <span class="tooltip-icon" title="选择水印的颜色">?</span></label>
          <input type="color" id="color" value="#ff0000">
        </div>
        
        <!-- 图片输出选项 -->
        <div class="form-group">
          <label for="image-quality">图片质量 <span class="tooltip-icon" title="调整输出图片的质量，值越高质量越好，文件越大">?</span></label>
          <div class="range-container">
            <input type="range" id="image-quality" min="10" max="100" value="92">
            <span id="image-quality-value">92%</span>
          </div>
        </div>
        
        <!-- 暂时注释掉输出格式选择
        <div class="form-group">
          <label for="image-format">输出格式 <span class="tooltip-icon" title="选择输出图片的格式">?</span></label>
          <select id="image-format">
            <option value="image/jpeg">JPEG (推荐)</option>
            <option value="image/png">PNG (无损)</option>
            <option value="image/webp">WebP (高压缩率)</option>
          </select>
        </div>
        -->
        
        <p class="help-text">提示：可以直接拖动水印调整位置，鼠标滚轮调整大小</p>
        
        <div class="batch-buttons">
          <button class="button" id="download-btn">下载单张图片</button>
          <button class="button" id="batch-download-btn">批量下载</button>
        </div>
        
        <!-- 撤销/重做按钮 -->
        <div class="undo-redo-buttons">
          <button class="icon-button" id="undo-btn" title="撤销"><span class="icon">↩</span></button>
          <button class="icon-button" id="redo-btn" title="重做"><span class="icon">↪</span></button>
        </div>
      </div>
    </div>
    
    <div class="preview-area">
      <!-- 添加背景色切换控件 -->
      <div class="bg-color-controls">
        <div class="bg-color-button bg-white active" data-color="#ffffff" title="白色背景"></div>
        <div class="bg-color-button bg-light-gray" data-color="#f5f5f5" title="浅灰背景"></div>
        <div class="bg-color-button bg-light-blue" data-color="#e6f7ff" title="浅蓝背景"></div>
        <div class="bg-color-button bg-light-green" data-color="#e6ffed" title="浅绿背景"></div>
        <div class="bg-color-button bg-light-yellow" data-color="#fffbe6" title="浅黄背景"></div>
      </div>
      
      <div class="preview-container" id="preview-container">
        <div id="no-image-message" style="text-align: center; padding: 20px;">请上传图片进行预览</div>
        <div id="gif-badge" class="gif-badge" style="display: none;">GIF</div>
        <img id="preview-image" class="preview-image" style="display: none;">
        <canvas id="preview-canvas" class="preview-image" style="display: none;"></canvas>
        <div id="watermark-container" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; pointer-events: auto; z-index: 10;"></div>
      </div>
      
      <div class="thumbnails-container" id="thumbnails-container" style="display: none;"></div>
    </div>
  </main>
  
  <!-- 进度模态框 -->
  <div id="processing-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">处理中...</h2>
      <p id="processing-status">正在处理图片...</p>
      <div class="progress-container" style="display: block;">
        <div id="modal-progress-bar" class="progress-bar" style="width: 0%">0%</div>
      </div>
    </div>
  </div>
  
  <!-- 帮助文档模态框 -->
  <div id="help-modal" class="modal">
    <div class="help-modal-content" id="help-modal-content">
      <!-- 内容将通过JavaScript动态添加 -->
    </div>
    <button class="close-button">&times;</button>
  </div>
  
  <!-- 状态消息 -->
  <div id="status-message" class="status-message"></div>
  
  <!-- 处理中弹窗 -->
  <div id="processing-popup" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>处理中...</h3>
      <div id="processing-status">正在准备图片...</div>
      <div class="progress-container">
        <div id="processing-progress-bar" class="progress-bar"></div>
      </div>
      <div id="processing-details" style="margin-top: 10px; font-size: 0.9em;"></div>
    </div>
  </div>
  
  <!-- 引入JavaScript模块 -->
  <script type="module" src="js/main.js"></script>
  
  <!-- 模块加载失败时的备选方案 -->
  <script>
    // 检测模块加载是否失败
    setTimeout(() => {
      if (!window.watermarkInitialized) {
        console.log('模块加载失败，尝试使用传统脚本加载');
        const errorMsg = document.getElementById('error-container');
        if (errorMsg) {
          errorMsg.innerHTML = '<p>模块加载失败。请通过本地服务器访问，而不是直接从文件系统打开。</p>' +
            '<p>推荐方法：</p>' +
            '<ol>' +
            '<li>使用命令行进入项目目录</li>' +
            '<li>运行 <code>npx http-server</code> 或任何本地开发服务器</li>' +
            '<li>在浏览器中访问 <a href="http://localhost:8080/standalone-app-new.html">http://localhost:8080/standalone-app-new.html</a></li>' +
            '</ol>';
          errorMsg.classList.add('show');
        }
      }
    }, 1000);
  </script>
</body>
</html>  